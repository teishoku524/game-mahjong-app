<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ€„ï¸ ã‚²ãƒ¼ãƒ å‹Ÿé›†</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
  </style>
</head>
<body>
  <div id="app"></div>

  <script type="module">
    import React, { useState, useEffect } from 'https://esm.sh/react@18.2.0';
    import ReactDOM from 'https://esm.sh/react-dom@18.2.0/client';

    function App() {
      const [events, setEvents] = useState([]);
      const [showCreateForm, setShowCreateForm] = useState(false);
      const [showSettings, setShowSettings] = useState(false);
      const [newEventTitle, setNewEventTitle] = useState('');
      const [newEventTime, setNewEventTime] = useState('');
      const [newEventDeadline, setNewEventDeadline] = useState('');
      const [newEventMinPlayers, setNewEventMinPlayers] = useState(3);
      const [newEventNote, setNewEventNote] = useState('');
      const [copiedId, setCopiedId] = useState(null);
      const [webhookUrl, setWebhookUrl] = useState('');
      const [tempWebhookUrl, setTempWebhookUrl] = useState('');

      useEffect(() => {
        loadEvents();
        loadWebhookUrl();
        
        // 1åˆ†ã”ã¨ã«æœŸé™åˆ‡ã‚Œã‚’ãƒã‚§ãƒƒã‚¯
        const interval = setInterval(checkExpiredEvents, 60000);
        return () => clearInterval(interval);
      }, []);

      const checkExpiredEvents = () => {
        const now = new Date();
        const stored = localStorage.getItem('events');
        if (!stored) return;
        
        const currentEvents = JSON.parse(stored);
        const activeEvents = currentEvents.filter(event => {
          if (!event.deadline) return true;
          const deadline = new Date(event.deadline);
          return deadline > now;
        });
        
        if (activeEvents.length !== currentEvents.length) {
          localStorage.setItem('events', JSON.stringify(activeEvents));
          setEvents(activeEvents);
        }
      };

      const loadWebhookUrl = () => {
        const saved = localStorage.getItem('discordWebhook');
        if (saved) {
          setWebhookUrl(saved);
          setTempWebhookUrl(saved);
        }
      };

      const saveWebhookUrl = () => {
        localStorage.setItem('discordWebhook', tempWebhookUrl);
        setWebhookUrl(tempWebhookUrl);
        setShowSettings(false);
        alert('Discord Webhookã‚’ä¿å­˜ã—ã¾ã—ãŸï¼âœ…');
      };

      const loadEvents = () => {
        const stored = localStorage.getItem('events');
        if (stored) {
          setEvents(JSON.parse(stored));
        }
      };

      const saveEvents = (newEvents) => {
        localStorage.setItem('events', JSON.stringify(newEvents));
        setEvents(newEvents);
      };

      const sendDiscordNotification = async (event) => {
        if (!webhookUrl) return;

        const eventUrl = `${window.location.href.split('#')[0]}#${event.id}`;
        
        let description = `â° ${event.time}\nğŸ‘¥ å¿…è¦äººæ•°: ${event.minPlayers}äºº`;
        if (event.deadline) {
          const deadline = new Date(event.deadline);
          description += `\nâ³ ç· åˆ‡: ${deadline.toLocaleString('ja-JP', { month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit' })}`;
        }
        if (event.note) {
          description += `\nğŸ“ ${event.note}`;
        }

        const embed = {
          title: `ğŸ® ${event.title}ã½`,
          description: description,
          color: 0x9333EA,
          fields: [
            {
              name: "å‚åŠ æ–¹æ³•",
              value: `[ã“ã“ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦å‚åŠ è¡¨æ˜](${eventUrl})`,
              inline: false
            }
          ],
          footer: {
            text: "ğŸ€„ï¸ ã§å‚åŠ è¡¨æ˜ã—ã‚ˆã†ï¼"
          },
          timestamp: new Date().toISOString()
        };

        try {
          const response = await fetch(webhookUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              content: "@everyone",
              embeds: [embed]
            })
          });

          if (!response.ok) {
            console.error('Discordé€šçŸ¥ã‚¨ãƒ©ãƒ¼');
          }
        } catch (error) {
          console.error('Discordé€šçŸ¥é€ä¿¡å¤±æ•—:', error);
        }
      };

      const createEvent = async () => {
        if (!newEventTitle.trim()) return;

        const eventId = `event_${Date.now()}`;
        const newEvent = {
          id: eventId,
          title: newEventTitle,
          time: newEventTime || 'ä»Šæ—¥',
          deadline: newEventDeadline || null,
          minPlayers: newEventMinPlayers,
          note: newEventNote,
          participants: [],
          createdAt: Date.now()
        };

        const updatedEvents = [newEvent, ...events];
        saveEvents(updatedEvents);
        
        setNewEventTitle('');
        setNewEventTime('');
        setNewEventDeadline('');
        setNewEventMinPlayers(3);
        setNewEventNote('');
        setShowCreateForm(false);

        await sendDiscordNotification(newEvent);
        alert('å‹Ÿé›†ã‚’ä½œæˆã—ã¦Discordã«é€šçŸ¥ã—ã¾ã—ãŸï¼ğŸ‰');
      };

      const deleteEvent = (eventId) => {
        if (!confirm('ã“ã®å‹Ÿé›†ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
        
        const updatedEvents = events.filter(e => e.id !== eventId);
        saveEvents(updatedEvents);
      };

      const joinEvent = async (eventId) => {
        const userId = getUserId();
        const eventIndex = events.findIndex(e => e.id === eventId);
        if (eventIndex === -1) return;

        const event = {...events[eventIndex]};
        const wasEnough = event.participants.length >= event.minPlayers;

        if (event.participants.includes(userId)) {
          event.participants = event.participants.filter(id => id !== userId);
        } else {
          event.participants.push(userId);
        }

        const isNowEnough = event.participants.length >= event.minPlayers;
        
        const updatedEvents = [...events];
        updatedEvents[eventIndex] = event;
        saveEvents(updatedEvents);

        if (!wasEnough && isNowEnough && webhookUrl) {
          try {
            await fetch(webhookUrl, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                content: `ğŸ‰ **${event.title}** ã®é–‹å‚¬ãŒæ±ºå®šã—ã¾ã—ãŸï¼\nğŸ‘¥ ${event.participants.length}äººé›†ã¾ã‚Šã¾ã—ãŸï¼`
              })
            });
          } catch (error) {
            console.error('Discordé€šçŸ¥ã‚¨ãƒ©ãƒ¼:', error);
          }
        }
      };

      const getUserId = () => {
        let userId = localStorage.getItem('userId');
        if (!userId) {
          userId = `user_${Math.random().toString(36).substr(2, 9)}`;
          localStorage.setItem('userId', userId);
        }
        return userId;
      };

      const copyEventUrl = (eventId) => {
        const url = `${window.location.href.split('#')[0]}#${eventId}`;
        navigator.clipboard.writeText(url);
        setCopiedId(eventId);
        setTimeout(() => setCopiedId(null), 2000);
      };

      const isUserJoined = (event) => {
        const userId = getUserId();
        return event.participants.includes(userId);
      };

      const isExpired = (event) => {
        if (!event.deadline) return false;
        return new Date(event.deadline) < new Date();
      };

      return React.createElement('div', { className: 'min-h-screen p-4' },
        React.createElement('div', { className: 'max-w-2xl mx-auto' },
          React.createElement('div', { className: 'text-center mb-8 pt-6' },
            React.createElement('div', { className: 'flex items-center justify-center gap-3 mb-2' },
              React.createElement('h1', { className: 'text-4xl font-bold text-white' }, 'ğŸ€„ï¸ ã‚²ãƒ¼ãƒ å‹Ÿé›†'),
              React.createElement('button', {
                onClick: () => setShowSettings(!showSettings),
                className: 'bg-white/20 hover:bg-white/30 text-white p-2 rounded-lg transition-all',
                title: 'Discordè¨­å®š'
              }, 'âš™ï¸')
            ),
            React.createElement('p', { className: 'text-purple-200' }, 'åŒ¿åã§å‚åŠ è¡¨æ˜ + Discordé€šçŸ¥'),
            webhookUrl && React.createElement('div', { className: 'flex items-center justify-center gap-2 mt-2' },
              React.createElement('span', { className: 'text-green-400 text-sm' }, 'ğŸ”” Discordé€£æºæ¸ˆã¿')
            )
          ),

          showSettings && React.createElement('div', { className: 'bg-white/10 backdrop-blur-lg rounded-xl p-6 mb-6 border border-white/20' },
            React.createElement('h2', { className: 'text-white font-bold text-xl mb-4' }, 'ğŸ”” Discord Webhookè¨­å®š'),
            React.createElement('p', { className: 'text-purple-200 text-sm mb-4' }, 'Discordé€šçŸ¥ã‚’æœ‰åŠ¹ã«ã™ã‚‹ã«ã¯ã€ã‚µãƒ¼ãƒãƒ¼ã§Webhook URLã‚’å–å¾—ã—ã¦ãã ã•ã„'),
            React.createElement('input', {
              type: 'text',
              placeholder: 'https://discord.com/api/webhooks/...',
              value: tempWebhookUrl,
              onChange: (e) => setTempWebhookUrl(e.target.value),
              className: 'w-full bg-white/20 text-white placeholder-purple-300 border border-white/30 rounded-lg px-4 py-3 mb-3 focus:outline-none focus:ring-2 focus:ring-purple-400'
            }),
            React.createElement('div', { className: 'flex gap-3' },
              React.createElement('button', {
                onClick: saveWebhookUrl,
                className: 'flex-1 bg-gradient-to-r from-green-400 to-blue-500 text-white py-3 rounded-lg font-bold'
              }, 'ä¿å­˜'),
              React.createElement('button', {
                onClick: () => setShowSettings(false),
                className: 'flex-1 bg-white/20 text-white py-3 rounded-lg font-bold'
              }, 'é–‰ã˜ã‚‹')
            )
          ),

          !showCreateForm ? React.createElement('button', {
            onClick: () => setShowCreateForm(true),
            className: 'w-full bg-gradient-to-r from-pink-500 to-purple-500 text-white py-4 rounded-xl font-bold text-lg shadow-lg mb-6'
          }, '+ æ–°ã—ãå‹Ÿé›†ã™ã‚‹') : React.createElement('div', { className: 'bg-white/10 backdrop-blur-lg rounded-xl p-6 mb-6 border border-white/20' },
            React.createElement('h2', { className: 'text-white font-bold text-xl mb-4' }, 'æ–°è¦å‹Ÿé›†'),
            React.createElement('input', {
              type: 'text',
              placeholder: 'ã‚²ãƒ¼ãƒ ã®ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆä¾‹ï¼šAPEXï¼‰',
              value: newEventTitle,
              onChange: (e) => setNewEventTitle(e.target.value),
              className: 'w-full bg-white/20 text-white placeholder-purple-200 border border-white/30 rounded-lg px-4 py-3 mb-3'
            }),
            React.createElement('input', {
              type: 'text',
              placeholder: 'é–‹å§‹æ™‚é–“ï¼ˆä¾‹ï¼š21:00ã€œã€ä»Šã‹ã‚‰ã€ãªã©ï¼‰',
              value: newEventTime,
              onChange: (e) => setNewEventTime(e.target.value),
              className: 'w-full bg-white/20 text-white placeholder-purple-200 border border-white/30 rounded-lg px-4 py-3 mb-3'
            }),
            React.createElement('div', { className: 'mb-3' },
              React.createElement('label', { className: 'text-purple-200 text-sm mb-2 block' }, 'å‹Ÿé›†ç· åˆ‡æ™‚é–“ï¼ˆä»»æ„ï¼‰'),
              React.createElement('input', {
                type: 'datetime-local',
                value: newEventDeadline,
                onChange: (e) => setNewEventDeadline(e.target.value),
                className: 'w-full bg-white/20 text-white border border-white/30 rounded-lg px-4 py-3'
              })
            ),
            React.createElement('div', { className: 'mb-3' },
              React.createElement('label', { className: 'text-purple-200 text-sm mb-2 block' }, 'å¿…è¦äººæ•°'),
              React.createElement('input', {
                type: 'number',
                min: '2',
                max: '10',
                value: newEventMinPlayers,
                onChange: (e) => setNewEventMinPlayers(parseInt(e.target.value)),
                className: 'w-full bg-white/20 text-white border border-white/30 rounded-lg px-4 py-3'
              })
            ),
            React.createElement('textarea', {
              placeholder: 'è£œè¶³æƒ…å ±ï¼ˆä»»æ„ï¼‰ä¾‹ï¼šãƒ©ãƒ³ã‚¯ãƒã€ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«ã€åˆå¿ƒè€…æ­“è¿ãªã©',
              value: newEventNote,
              onChange: (e) => setNewEventNote(e.target.value),
              rows: 3,
              className: 'w-full bg-white/20 text-white placeholder-purple-200 border border-white/30 rounded-lg px-4 py-3 mb-4'
            }),
            React.createElement('div', { className: 'flex gap-3' },
              React.createElement('button', {
                onClick: createEvent,
                className: 'flex-1 bg-gradient-to-r from-green-400 to-blue-500 text-white py-3 rounded-lg font-bold'
              }, webhookUrl ? 'ä½œæˆ & Discordé€šçŸ¥' : 'ä½œæˆ'),
              React.createElement('button', {
                onClick: () => setShowCreateForm(false),
                className: 'flex-1 bg-white/20 text-white py-3 rounded-lg font-bold'
              }, 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«')
            )
          ),

          React.createElement('div', { className: 'space-y-4' },
            events.length === 0 ? React.createElement('div', { className: 'text-center py-12 text-purple-200' },
              React.createElement('p', null, 'ã¾ã å‹Ÿé›†ãŒã‚ã‚Šã¾ã›ã‚“')
            ) : events.map(event => {
              const isEnough = event.participants.length >= event.minPlayers;
              const userJoined = isUserJoined(event);
              const expired = isExpired(event);

              return React.createElement('div', {
                key: event.id,
                className: `bg-white/10 backdrop-blur-lg rounded-xl p-6 border-2 ${isEnough ? 'border-green-400' : expired ? 'border-red-400' : 'border-white/20'}`
              },
                React.createElement('div', { className: 'flex justify-between items-start mb-4' },
                  React.createElement('div', { className: 'flex-1' },
                    React.createElement('h3', { className: 'text-white font-bold text-xl mb-1' }, event.title),
                    React.createElement('p', { className: 'text-purple-200 text-sm' }, 'â° ' + event.time),
                    event.deadline && React.createElement('p', { className: `text-sm ${expired ? 'text-red-400' : 'text-purple-300'}` },
                      'â³ ç· åˆ‡: ' + new Date(event.deadline).toLocaleString('ja-JP', { month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit' })
                    ),
                    event.note && React.createElement('p', { className: 'text-purple-200 text-sm mt-2' }, 'ğŸ“ ' + event.note)
                  ),
                  React.createElement('div', { className: 'flex gap-2' },
                    React.createElement('button', {
                      onClick: () => copyEventUrl(event.id),
                      className: 'bg-white/20 hover:bg-white/30 text-white p-2 rounded-lg',
                      title: 'URLã‚’ã‚³ãƒ”ãƒ¼'
                    }, copiedId === event.id ? 'âœ“' : 'ğŸ“‹'),
                    React.createElement('button', {
                      onClick: () => deleteEvent(event.id),
                      className: 'bg-red-500/20 hover:bg-red-500/30 text-red-200 p-2 rounded-lg',
                      title: 'å‰Šé™¤'
                    }, 'ğŸ—‘ï¸')
                  )
                ),
                React.createElement('div', { className: 'mb-4' },
                  React.createElement('div', { className: 'flex items-center gap-2 mb-2' },
                    React.createElement('span', { className: 'text-white font-bold' },
                      `${event.participants.length} / ${event.minPlayers}äºº`
                    ),
                    isEnough && React.createElement('span', { className: 'bg-green-500 text-white text-xs px-2 py-1 rounded-full font-bold' }, 'é–‹å‚¬æ±ºå®šï¼'),
                    expired && React.createElement('span', { className: 'bg-red-500 text-white text-xs px-2 py-1 rounded-full font-bold' }, 'å‹Ÿé›†çµ‚äº†')
                  ),
                  React.createElement('div', { className: 'flex gap-1 flex-wrap' },
                    event.participants.map((_, i) => React.createElement('span', { key: i, className: 'text-3xl' }, 'ğŸ€„ï¸'))
                  )
                ),
                !expired && React.createElement('button', {
                  onClick: () => joinEvent(event.id),
                  className: `w-full py-3 rounded-lg font-bold ${userJoined ? 'bg-red-500 hover:bg-red-600 text-white' : 'bg-gradient-to-r from-yellow-400 to-orange-500 text-white'}`
                }, userJoined ? 'ğŸ€„ï¸ å‚åŠ å–ã‚Šæ¶ˆã—' : 'ğŸ€„ï¸ å‚åŠ ã™ã‚‹')
              );
            })
          )
        )
      );
    }

    ReactDOM.createRoot(document.getElementById('app')).render(React.createElement(App));
  </script>
</body>
</html>